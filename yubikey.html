<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>WebAuthn Example</title>
</head>

<body>
	<h1>WebAuthn Example</h1>
	<button id="registerButton">Register YubiKey</button>
	<!-- Add an element to display the challenge for debugging purposes -->
	<div id="challengeDisplay"></div>

	<script>
		const BASEURL = "http://localhost:3000";
		document.addEventListener('DOMContentLoaded', () => {
			const registerButton = document.getElementById('registerButton');
			const challengeDisplay = document.getElementById('challengeDisplay');

			registerButton.addEventListener('click', async () => {
				try {
					// Replace 'yourUserId' with the actual user ID or fetch it dynamically
					const userId = 'yourUserId';

					// Request a challenge from the server
					const response = await fetch(BASEURL + '/register', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({ userId }),
					});

					const { challenge } = await response.json();

					// Display the challenge for debugging purposes
					challengeDisplay.innerText = `Challenge: ${challenge}`;

					// Use the challenge in the WebAuthn registration process
					const credential = await navigator.credentials.create({
						publicKey: {
							challenge: Uint8Array.from(base64url.toBuffer(challenge), c => c.charCodeAt(0)),
							rp: { name: 'Your Web Service' },
							user: { id: Uint8Array.from(userId), name: userId, displayName: userId },
							pubKeyCredParams: [
								{ type: 'public-key', alg: -7 }, // Use the desired algorithm, -7 represents ES256
							],
							attestation: 'direct',
							authenticatorSelection: { authenticatorAttachment: 'cross-platform' },
						},
					});

					// Send the registration response to the server
					await fetch(BASEURL+'/verify-registration', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({
							userId,
							id: credential.id,
							rawId: base64url.encode(credential.rawId),
							response: {
								attestationObject: base64url.encode(credential.response.attestationObject),
								clientDataJSON: base64url.encode(credential.response.clientDataJSON),
							},
							type: credential.type,
						}),
					});

					console.log('YubiKey registered successfully:', credential);

				} catch (error) {
					console.error('Error registering YubiKey:', error);
				}
			});
		});
	</script>

	<script>
		// Include the base64url library for encoding and decoding
		const base64url = {
			toBuffer: (b64) => Uint8Array.from(atob(b64), c => c.charCodeAt(0)),
			encode: (arr) => btoa(String.fromCharCode.apply(null, new Uint8Array(arr))),
		};
	</script>
</body>

</html>